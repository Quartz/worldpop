function frameMessager(opts){var frameMessager={isInitialized:!1,protocol:"http://",parentDomain:"",subdomains:["app","ads","data"],domainWhitelist:[],history:[],message:{},events:null,windowConfirmed:!1,isParent:!1,windowId:null,children:{},idCounter:0,activeWpid:null,isActive:!1,eventPrefix:"QZFM:",init:function(){if(this.testIsParent(opts),this.isParent)this.windowId="QZParent","undefined"!=typeof QZ&&"undefined"!=typeof QZ.events&&(this.events=QZ.events);else{if("undefined"==typeof jQuery)throw"frameMessager.js requires jQuery in child frames";this.windowId=window.name||window.frameElement.id,this.trackActivePost()}this.setupSubdomains(opts),this.setupWhitelist(opts);var self=this;window.addEventListener("message",function(event){if(self.confirmOrigin(event)){var timeNow=null;"undefined"!=typeof Date&&"function"==typeof Date.now&&(timeNow=Date.now());var message={raw:event.data,received:timeNow,valid:!0,data:null};try{message.data=JSON.parse(event.data)}catch(e){message.valid=!1}if(self.history.unshift(message),message.valid&&self.validateMessage(message.data)){var actionName=self.isParent?self.eventPrefix+message.data.action:message.data.action;self.events?self.events.trigger(actionName,message.data):jQuery(document).trigger({type:actionName,msgObj:message.data})}else if(self.isParent&&QZ.config.devTools.debugPostMessage)throw console.log(message.data),"Invalid message format received from "+event.origin}},!1),this.isParent||(this.allowFullWindow=this.parseOptBoolean(opts,"allowFullWindow"),this.requestHeight=this.parseOptBoolean(opts,"requestHeight"),this.fullWindowDeeplink=this.parseOptBoolean(opts,"fullWindowDeeplink"),this.registerWithParent()),this.isInitialized=!0},onMessage:function(action,callback,context){"child:confirmed"===action&&("function"==typeof console.log&&console.log(this.windowId+": 'child:confirmed' action is deprecated. Use 'parent:childConfirmed' instead."),action="parent:childConfirmed"),this.isParent&&(action=this.eventPrefix+action),this.events?this.events.on(action,callback,context):(context||(context=this),jQuery(document).on(action,function(e){callback.call(context,e.msgObj)}))},offMessage:function(action,callback,context){this.isParent&&(action=this.eventPrefix+action),this.events?this.events.off(action,callback,context):jQuery(document).off(action)},triggerMessage:function(target,action,data){if(this.isUndefined(target)||!target||"QZParent"===target)var toId="QZParent",targetWindow=window.parent;else{if(this.isUndefined(this.children[target]))throw target+" is not a valid child window object";if(!document.getElementById(target))return delete this.children[target],void 0;var toId=target,targetWindow=this.children[target].windowObj}if(this.isUndefined(action))throw"frameMessager.triggerMessage() requires an action to trigger";this.isUndefined(data)&&(data={});var message={action:action,fromId:this.windowId,toId:toId,data:data};if(!this.validateMessage(message))throw"Attempted to send invalid message data: "+JSON.stringify(message);var destination=this.protocol+this.parentDomain;"QZParent"===this.windowId&&(destination=this.children[target].url.split("?")[0]),this.isParent&&this.events&&this.events.trigger(this.eventPrefix+"send",message),targetWindow.postMessage(JSON.stringify(message),destination)},validateMessage:function(messageData){return this.isUndefined(messageData.action)||!this.isString(messageData.action)?!1:this.isUndefined(messageData.toId)||messageData.toId!==this.windowId&&messageData.fromId!==this.windowId?!1:!this.isUndefined(messageData.data)&&this.isObject(messageData.data)?!this.isFunction(messageData.data):!0},parseOptBoolean:function(opts,key){return this.isUndefined(opts)||this.isUndefined(opts[key])?!1:opts[key]?opts[key]:!1},registerWithParent:function(){if(window.parent&&this.windowId&&"QZParent"!==this.windowId){var registrationData={url:window.location.href,allowFullWindow:this.allowFullWindow,requestHeight:this.requestHeight,fullWindowDeeplink:this.fullWindowDeeplink};this.triggerMessage(null,"child:register",registrationData)}},testIsParent:function(opts){this.isParent=!this.isUndefined(opts)&&!this.isUndefined(opts.isParent)&&opts.isParent===!0},trackActivePost:function(){this.onMessage("app:activePost parent:childConfirmed",function(msgObj){frameMessager.activeId=msgObj.data.wpid,0===this.windowId.indexOf("interative")&&(this.isActive=frameMessager.activeId===parseInt(this.windowId.replace("interative","")))},this)},confirmOrigin:function(event){var parser=document.createElement("a");return parser.href=event.origin,-1!==this.domainWhitelist.indexOf(parser.hostname)},setupWhitelist:function(opts){if((this.isUndefined(opts)||this.isUndefined(opts.whitelistSelf)||opts.whitelistSelf!==!1)&&this.domainWhitelist.push(window.location.hostname),this.isUndefined(opts)||this.isUndefined(opts.parentDomain)||!this.isString(opts.parentDomain)){var domainArray=this.domainWhitelist[0].split(".").reverse();this.parentDomain=domainArray[1]+"."+domainArray[0]}else this.parentDomain=opts.parentDomain;this.domainWhitelist.push(this.parentDomain),this.each(this.subdomains,function(subdomain){this.domainWhitelist.push(subdomain+"."+this.parentDomain)},this),this.isUndefined(opts)||this.isUndefined(opts.domainWhitelist)||!this.isArray(opts.domainWhitelist)||(this.domainWhitelist=this.domainWhitelist.concat(opts.domainWhitelist)),this.domainWhitelist=this.uniq(this.domainWhitelist)},setupSubdomains:function(opts){this.isUndefined(opts)||this.isUndefined(opts.subdomains)||!this.isArray(opts.subdomains)||(this.subdomains=this.subdomains.concat(opts.subdomains)),this.subdomains=this.uniq(this.subdomains)},isUndefined:function(obj){return void 0===obj},isString:function(obj){return"[object String]"==Object.prototype.toString.call(obj)},isObject:function(obj){return obj===Object(obj)},isFunction:function(obj){return"[object Function]"==Object.prototype.toString.call(obj)},isArray:function(obj){return"[object Array]"==Object.prototype.toString.call(obj)},each:function(obj,iterator,context){var breaker={},nativeForEach=Array.prototype.forEach;if(null!=obj)if(nativeForEach&&obj.forEach===nativeForEach)obj.forEach(iterator,context);else if(obj.length===+obj.length){for(var i=0,l=obj.length;l>i;i++)if(iterator.call(context,obj[i],i,obj)===breaker)return}else for(var key in obj)if(Object.prototype.hasOwnProperty.call(obj,key)&&iterator.call(context,obj[key],key,obj)===breaker)return},uniq:function(obj){if(null==obj||this.isUndefined(obj.length))return!1;var results=[];if(this.isUndefined(obj.indexOf))for(var i=0;i<obj.length;i++)this.inList(obj,results)||results.push(obj[i]);else this.each(obj,function(value){-1===results.indexOf(value)&&results.push(value)},this);return results},inList:function(value,list){for(var i=0;i<list.length;i++)if(value===list[i])return!0;return!1},uniqueId:function(prefix){var id=++this.idCounter+"";return prefix?prefix+id:id}};return frameMessager.init(),frameMessager}